<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgreens La Isla - Gestión Profesional Cloud</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #27ae60; --primary-dark: #1e8449; --bg: #f4f6f8; --surface: #ffffff;
            --text: #333; --text-light: #7f8c8d; --border: #dcdde1; --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --danger: #e74c3c; --warning: #f1c40f; --info: #3498db; --purple: #9b59b6;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- ESTILOS PARA MODO MÓVIL FORZADO --- */
        body.mobile-view { overflow: auto; }
        body.mobile-view .sidebar { width: 80px; }
        body.mobile-view .sidebar-header { font-size: 0.7rem; padding: 10px 5px; }
        body.mobile-view .nav-item span { display: none; }
        body.mobile-view .nav-item i { margin-right: 0; font-size: 1.5rem; }
        body.mobile-view .main { zoom: 0.8; -moz-transform: scale(0.8); -moz-transform-origin: 0 0; padding: 15px; }

        .sidebar { width: 250px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; background-color: #1a252f; border-bottom: 1px solid #34495e; }
        .nav-menu { flex-grow: 1; padding: 10px 0; }
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; transition: 0.3s; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: #34495e; }
        .nav-item.active { background-color: #34495e; border-left: 4px solid var(--primary); }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }
        .main { flex-grow: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; transition: all 0.3s; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--surface); padding: 20px; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8f9fa; font-size: 0.8rem; color: #666; text-transform: uppercase; }
        .calendar-container { background: white; border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; margin-top: 20px; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #2c3e50; color: white; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #ddd; }
        .calendar-day-head { background: #f8f9fa; padding: 10px; text-align: center; font-weight: bold; font-size: 0.8rem; color: #666; }
        .calendar-day { background: white; min-height: 120px; padding: 5px; position: relative; }
        .day-num { font-weight: bold; margin-bottom: 5px; display: block; color: #999; }
        .visit-tag { background: var(--info); color: white; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; line-height: 1.2; }
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-card p { margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: var(--primary); }
        .calendar-accordion { border: 2px solid var(--primary); border-radius: 10px; overflow: hidden; }
        .calendar-header { background: var(--primary); color: white; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .calendar-content { display: none; background: white; padding: 10px; max-height: 500px; overflow-y: auto; }
        .calendar-content.show { display: block; }
        .task-date-title { background: #f0f2f5; padding: 8px; font-weight: bold; margin-top: 10px; border-radius: 4px; border-left: 5px solid #ccc; font-size: 0.85rem; }
        .task-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .task-row.completed { opacity: 0.5; text-decoration: line-through; }
        .badge-task { padding: 2px 8px; border-radius: 12px; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; width: 65px; text-align: center; }
        .bg-remojo { background: var(--purple); } .bg-siembra { background: var(--info); } .bg-luz { background: var(--warning); color: #333; } .bg-cosecha { background: var(--danger); }
        .form-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; color: var(--text-light); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 5px; box-sizing: border-box; font-family: inherit; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-info { background-color: var(--info); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-purple { background-color: var(--purple); color: white; }
        .search-box { margin-bottom: 15px; position: relative; }
        .search-box i { position: absolute; left: 10px; top: 12px; color: var(--text-light); }
        .search-box input { padding-left: 35px; border: 2px solid var(--info); }
        .mix-selector-box { border: 2px solid var(--purple); border-radius: 10px; padding: 15px; margin-top: 10px; display: none; }
        .plt-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 5px; }
        .plt-check-item { display: flex; align-items: center; justify-content: space-between; padding: 5px; border-bottom: 1px solid #f0f0f0; }
        .plt-info-mix { font-size: 0.75rem; color: var(--text-light); flex-grow: 1; margin-left: 10px; }
        .plt-check-item input[type="number"] { width: 60px; }
        .mix-detail-list { font-size: 0.75rem; color: var(--purple); margin-top: 5px; list-style: none; padding-left: 0; }
        .mix-detail-list li { display: inline-block; background: #f3ebff; padding: 2px 6px; border-radius: 4px; margin: 2px; }
        #cloud-status { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; background: #333; color: #fff; padding: 4px 10px; border-radius: 20px; opacity: 0.7; z-index: 1000; }
        .alert-date { color: var(--danger); font-size: 0.75rem; font-weight: bold; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <div id="cloud-status">Conectando a la nube...</div>

    <aside class="sidebar">
        <div class="sidebar-header" id="sidebar-title">LA ISLA GESTIÓN</div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard')"><i class="fas fa-chart-line"></i> <span>Dashboard</span></div>
            <div class="nav-item" onclick="showSection('clientes')"><i class="fas fa-users"></i> <span>Clientes</span></div>
            <div class="nav-item" onclick="showSection('plantas')"><i class="fas fa-seedling"></i> <span>Plantas</span></div>
            <div class="nav-item" onclick="showSection('planes')"><i class="fas fa-calendar-alt"></i> <span>Planes</span></div>
            <div class="nav-item" onclick="showSection('lotes')"><i class="fas fa-barcode"></i> <span>Lotes</span></div>
            <div class="nav-item" onclick="showSection('visitas')"><i class="fas fa-map-marker-alt"></i> <span>Visitas</span></div>
            <div class="nav-item" onclick="showSection('calculadora')"><i class="fas fa-calculator"></i> <span>Calculadora</span></div>
            <div class="nav-item" onclick="showSection('config')"><i class="fas fa-cog"></i> <span>Configuración</span></div>
            <hr style="border: 0; border-top: 1px solid #34495e; margin: 10px 0;">
            <div class="nav-item" onclick="toggleMobileView()" style="color: var(--warning);">
                <i class="fas fa-mobile-alt"></i> <span id="view-text">Vista: Móvil</span>
            </div>
        </nav>
    </aside>

    <main class="main">
        <section id="dashboard" class="section active">
            <h2>Dashboard</h2>
            <div class="grid-dashboard">
                <div class="card stat-card"><h3>Clientes</h3><p id="stat-clientes">0</p></div>
                <div class="card stat-card"><h3>Planes</h3><p id="stat-planes">0</p></div>
                <div class="card stat-card"><h3>Lotes</h3><p id="stat-lotes">0</p></div>
            </div>
            <div class="calendar-accordion">
                <div class="calendar-header" onclick="toggleCalendar()">
                    <span><i class="fas fa-list-check"></i> TAREAS DIARIAS</span>
                    <i id="cal-icon" class="fas fa-chevron-down"></i>
                </div>
                <div id="calendar-body" class="calendar-content"></div>
            </div>
        </section>

        <section id="clientes" class="section">
            <h2>Gestión de Clientes</h2>
            <div class="card">
                <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="cli-nombre"></div>
                <button class="btn btn-primary" onclick="addCliente()" style="margin-top:10px;">Añadir Cliente</button>
            </div>
            <div class="card"><table id="table-clientes"><thead><tr><th>Nombre</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
        </section>

        <section id="plantas" class="section">
            <h2>Gestión de Plantas</h2>
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <div class="form-group"><label>ID (3 letras)</label><input type="text" id="plt-id" maxlength="3"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="plt-nombre"></div>
                    <div class="form-group"><label>Remojo (h)</label><input type="number" id="plt-remojo" value="0"></div>
                    <div class="form-group"><label>Oscuro (d)</label><input type="number" id="plt-oscuro" value="3"></div>
                    <div class="form-group"><label>Total (d)</label><input type="number" id="plt-total" value="10"></div>
                    <div class="form-group"><label>Gr/Band. Est.</label><input type="number" id="plt-gramos" value="200"></div>
                    <div class="form-group"><label>Precio/Kg (€)</label><input type="number" id="plt-precio" value="0" step="0.01"></div>
                </div>
                <button class="btn btn-primary" onclick="addPlanta()" style="margin-top:15px;">Guardar / Actualizar Planta</button>
            </div>
            <div class="card">
                <table id="table-plantas">
                    <thead><tr><th>ID</th><th>Nombre</th><th>Remojo</th><th>Total</th><th>Precio/Kg</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="planes" class="section">
            <h2>Planes de Siembra</h2>
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div class="form-group"><label>Cliente</label><select id="plan-cliente"></select></div>
                    <div class="form-group"><label>Tipo Bandeja</label>
                        <select id="plan-tipo-bandeja">
                            <option value="Estándar (25x50)">Estándar (25x50)</option>
                            <option value="Cuadrada (12x12)">Cuadrada (12x12)</option>
                            <option value="Pequeña (9x9)">Pequeña (9x9)</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Frecuencia (d)</label><input type="number" id="plan-frec" value="7"></div>
                </div>

                <div id="panel-individual" style="margin-top:20px; padding:15px; border:1px solid #ddd; border-radius:8px;">
                    <p style="font-weight:bold; color:var(--primary);">MODO INDIVIDUAL (POR ENTREGA)</p>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                        <div class="form-group">
                            <label>Planta</label>
                            <select id="plan-planta" onchange="updateDiasInfo()"></select>
                            <small id="plan-dias-info" style="color: var(--primary); font-weight: bold; display: block; margin-top: 5px;"></small>
                        </div>
                        <div class="form-group"><label>Nº Bandejas</label><input type="number" id="plan-cant-ind" value="1"></div>
                        <div class="form-group">
                            <label>Fecha Entrega Final</label>
                            <input type="date" id="plan-fecha" onchange="validateLeadTime()">
                            <div id="date-alert" class="alert-date">⚠️ No hay tiempo suficiente para cultivar esta planta.</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="addPlan()">Guardar Individual</button>
                        <button class="btn btn-purple" onclick="togglePlanModo('mix')">Cambiar a Modo MIX</button>
                    </div>
                </div>

                <div id="panel-mix" class="mix-selector-box">
                    <p style="font-weight:bold; color:var(--purple);">MODO MIX</p>
                    <div class="form-group" style="max-width:300px;"><label>Fecha Entrega Final</label><input type="date" id="plan-fecha-entrega"></div>
                    <div class="plt-list-grid" id="mix-lista-check"></div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button class="btn btn-purple" onclick="addPlanMix()">Guardar Plan Mix</button>
                        <button class="btn" onclick="togglePlanModo('individual')">Volver a Individual</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <table id="table-planes">
                    <thead><tr><th>Cliente</th><th>Tipo</th><th>Detalle de Plantas</th><th>Acción</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="lotes" class="section">
            <h2>Gestión de Lotes</h2>
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="form-group"><label>Planta</label><select id="lote-planta"></select></div>
                    <div class="form-group"><label>Cliente</label><select id="lote-cliente"></select></div>
                    <div class="form-group"><label>Cant. Bandejas</label><input type="number" id="lote-cant" value="1"></div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="lote-fecha"></div>
                </div>
                <button class="btn btn-primary" style="margin-top:15px;" onclick="addLoteManual()">Generar Lote Progresivo</button>
            </div>
            <div class="card">
                <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-lote-cliente" placeholder="Buscar por cliente..." onkeyup="filterLotes()"></div>
                <table id="table-lotes"><thead><tr><th>Código</th><th>Planta</th><th>Cliente</th><th>Cant</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tbody-lotes"></tbody></table>
            </div>
        </section>

        <section id="visitas" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>Agenda de Visitas</h2>
                <div>
                    <button class="btn btn-primary" onclick="toggleVisitsView('calendario')">Calendario</button>
                    <button class="btn btn-primary" onclick="toggleVisitsView('lista')">Lista</button>
                </div>
            </div>
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div class="form-group"><label>Cliente</label><select id="visita-cliente"></select></div>
                    <div class="form-group"><label>Fecha</label><input type="date" id="visita-fecha"></div>
                    <div class="form-group"><label>Hora</label><input type="time" id="visita-hora"></div>
                    <div class="form-group"><label>Motivo</label><input type="text" id="visita-motivo"></div>
                </div>
                <button class="btn btn-primary" style="margin-top:10px;" onclick="addVisita()">Registrar Visita</button>
            </div>
            <div id="visitas-calendario" class="calendar-container">
                <div class="calendar-nav"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><h3 id="cal-title">MES</h3><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div>
                <div class="calendar-grid" id="visitas-grid"></div>
            </div>
            <div id="visitas-lista" class="card" style="display:none;"><table id="table-visitas"><thead><tr><th>Cliente</th><th>Fecha</th><th>Motivo</th><th>Acción</th></tr></thead><tbody></tbody></table></div>
        </section>

        <section id="calculadora" class="section">
            <h2>Calculadora de Semillas</h2>
            <div class="card">
                <div class="form-group"><label>Planta</label><select id="calc-planta" onchange="runCalc()"></select></div>
                <div class="form-group"><label>Tipo Bandeja</label>
                    <select id="calc-bandeja" onchange="runCalc()">
                        <option value="1250">Estándar (25x50)</option>
                        <option value="144">Cuadrada (12x12)</option>
                        <option value="81">Pequeña (9x9)</option>
                    </select>
                </div>
                <div id="calc-res" class="card" style="margin-top:15px; background:#e8f6ed; font-size: 1.2rem; text-align: center;">Resultados...</div>
            </div>
        </section>

        <section id="config" class="section">
            <h2>Configuración & Sincronización</h2>
            <div class="card">
                <p>Usa el botón "Recuperar Datos" para cargar tu archivo anterior en la nube.</p>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <input type="file" id="import-file" style="display:none" onchange="importToCloud(event)">
                    <button class="btn btn-info" onclick="document.getElementById('import-file').click()"><i class="fas fa-upload"></i> RECUPERAR DATOS (IMPORTAR JSON)</button>
                    <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Exportar Copia JSON</button>
                    <button class="btn btn-danger" onclick="clearData()"><i class="fas fa-trash"></i> Borrar Todo</button>
                </div>
            </div>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://la-isla-microgreen-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let db = { clientes: [], plantas: [], planes: [], lotes: [], completadas: [], visitas: [], ultimoCorrelativo: 0 };
        let curMonth = new Date();
        const B_AREAS = { "Estándar (25x50)": 1250, "Cuadrada (12x12)": 144, "Pequeña (9x9)": 81 };

        function initApp() {
            database.ref('micro_db_isla').on('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (cloudData) {
                    db = cloudData;
                    refresh();
                    document.getElementById('cloud-status').innerText = "Nube sincronizada";
                } else {
                    document.getElementById('cloud-status').innerText = "Nube vacía. Importa tu copia.";
                }
            });
        }

        function toggleMobileView() {
            const body = document.body;
            const text = document.getElementById('view-text');
            const title = document.getElementById('sidebar-title');
            if (body.classList.contains('mobile-view')) {
                body.classList.remove('mobile-view');
                text.innerText = "Vista: Móvil";
                title.innerText = "LA ISLA GESTIÓN";
            } else {
                body.classList.add('mobile-view');
                text.innerText = "Vista: PC";
                title.innerText = "ISLA";
            }
        }

        function save() {
            database.ref('micro_db_isla').set(db);
            refresh();
        }

        function importToCloud(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imported = JSON.parse(ev.target.result);
                if(confirm("Se subirán todos tus datos antiguos a la nube. ¿OK?")) {
                    db = imported;
                    save();
                    alert("¡Datos recuperados con éxito!");
                }
            };
            reader.readAsText(e.target.files[0]);
        }

        function refresh() {
            const cliOpt = (db.clientes || []).map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
            const pltOpt = (db.plantas || []).map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            document.getElementById('visita-cliente').innerHTML = cliOpt; 
            document.getElementById('plan-cliente').innerHTML = cliOpt; 
            document.getElementById('plan-planta').innerHTML = pltOpt;
            document.getElementById('lote-planta').innerHTML = pltOpt; 
            document.getElementById('lote-cliente').innerHTML = cliOpt; 
            document.getElementById('calc-planta').innerHTML = pltOpt;
            
            document.getElementById('mix-lista-check').innerHTML = (db.plantas || []).map(p => `
                <div class="plt-check-item mix-row">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="mix-chk" value="${p.id}"> 
                        <span style="margin-left: 8px; font-weight: 500;">${p.nombre}</span>
                        <span class="plt-info-mix">(${p.total} días)</span>
                    </label>
                    <input type="number" class="mix-qty" value="0" min="0" placeholder="Cant.">
                </div>`).join('');
            
            document.querySelector('#table-planes tbody').innerHTML = (db.planes || []).map(p => {
                let det = "";
                if(p.tipo === 'MIX') {
                    const noms = p.detalleMix.map(item => {
                        const pl = db.plantas.find(x => x.id === item.id);
                        return pl ? `${pl.nombre} (x${item.cant})` : item.id;
                    });
                    det = `<strong>MIX:</strong><ul class="mix-detail-list"><li>${noms.join('</li><li>')}</li></ul>`;
                } else {
                    const pl = db.plantas.find(x => x.id === p.plantaId);
                    det = `Indiv: ${pl ? pl.nombre : p.plantaId} (x${p.cant})`;
                }
                return `<tr><td>${p.cliente}</td><td>${p.tipo}</td><td>${det}<br><small>[${p.bandeja}]</small></td><td><button class="btn btn-danger" onclick="borrar('planes',${p.id})">X</button></td></tr>`;
            }).join('');

            document.querySelector('#table-plantas tbody').innerHTML = (db.plantas || []).map(p => `<tr><td>${p.id}</td><td>${p.nombre}</td><td>${p.remojo}h / ${p.oscuro}d</td><td>${p.total}d</td><td>${p.precio}€</td><td><button class="btn btn-info" onclick="editPlanta('${p.id}')">E</button><button class="btn btn-danger" onclick="borrar('plantas','${p.id}')">X</button></td></tr>`).join('');
            document.querySelector('#table-clientes tbody').innerHTML = (db.clientes || []).map(c => `<tr><td>${c.nombre}</td><td><button class="btn btn-danger" onclick="borrar('clientes',${c.id})">X</button></td></tr>`).join('');
            document.querySelector('#table-visitas tbody').innerHTML = (db.visitas || []).map(v => `<tr><td>${v.cliente}</td><td>${v.fecha}</td><td>${v.motivo}</td><td><button class="btn btn-danger" onclick="borrar('visitas',${v.id})">X</button></td></tr>`).join('');
            
            renderLotesTable(db.lotes || []);
            document.getElementById('stat-clientes').innerText = (db.clientes || []).length; 
            document.getElementById('stat-planes').innerText = (db.planes || []).length; 
            document.getElementById('stat-lotes').innerText = (db.lotes || []).length;
            
            updateDiasInfo(); 
            generateTasks(); 
            renderVisitsCal();
        }

        function updateDiasInfo() {
            const pltId = document.getElementById('plan-planta').value;
            const plt = (db.plantas || []).find(x => x.id === pltId);
            const infoSpan = document.getElementById('plan-dias-info');
            if(plt && infoSpan) {
                infoSpan.innerText = `Ciclo total de siembra a cosecha: ${plt.total} días`;
                validateLeadTime();
            }
        }

        function validateLeadTime() {
            const dateVal = document.getElementById('plan-fecha').value;
            const pltId = document.getElementById('plan-planta').value;
            const alertBox = document.getElementById('date-alert');
            if(!dateVal || !pltId) return;
            const plt = db.plantas.find(x => x.id === pltId);
            const entrega = new Date(dateVal);
            const hoy = new Date();
            hoy.setHours(0,0,0,0);
            const siembraNecesaria = new Date(entrega);
            siembraNecesaria.setDate(siembraNecesaria.getDate() - plt.total);
            if(siembraNecesaria < hoy) alertBox.style.display = "block"; else alertBox.style.display = "none";
        }

        /* --- LOGICA MODIFICADA PARA MOSTRAR GRAMOS Y BANDEJA --- */
        function generateTasks() {
            const body = document.getElementById('calendar-body'); if(!body) return;
            body.innerHTML = ''; const tasks = [];
            (db.planes || []).forEach(plan => {
                for(let i=0; i<4; i++) {
                    if(plan.tipo === 'INDIVIDUAL') {
                        const plt = db.plantas.find(x => x.id === plan.plantaId); if(!plt) return;
                        let entrega = new Date(plan.fecha);
                        entrega.setDate(entrega.getDate() + (i * plan.frec));
                        let s = new Date(entrega);
                        s.setDate(s.getDate() - plt.total);
                        crearHitos(tasks, s, plt, plan.cant, plan);
                    } else {
                        let c = new Date(plan.fechaEntrega); 
                        c.setDate(c.getDate() + (i * plan.frec));
                        plan.detalleMix.forEach(item => {
                            const plt = db.plantas.find(x => x.id === item.id); if(!plt) return;
                            let s = new Date(c); 
                            s.setDate(s.getDate() - plt.total);
                            crearHitos(tasks, s, plt, item.cant, plan);
                        });
                    }
                }
            });
            const filtradas = tasks.filter(t => t.fecha >= new Date(new Date().setHours(0,0,0,0))).sort((a,b) => a.fecha - b.fecha).slice(0,30);
            let lastD = "";
            filtradas.forEach(t => {
                const dStr = t.fecha.toLocaleDateString('es-ES', { weekday:'long', day:'numeric', month:'short' }).toUpperCase();
                if(dStr !== lastD) { body.innerHTML += `<div class="task-date-title">${dStr}</div>`; lastD = dStr; }
                const isDone = (db.completadas || []).includes(t.tid);
                body.innerHTML += `<div class="task-row ${isDone?'completed':''}" onclick="toggleTask('${t.tid}')"><span class="badge-task bg-${t.tipo}">${t.tipo}</span> <strong>${t.msg}</strong> (${t.cli})</div>`;
            });
        }

        function crearHitos(tasks, s, plt, cant, plan) {
            const add = (f, t, m) => tasks.push({ fecha: new Date(f), tipo: t, msg: m, cli: plan.cliente, tid: `${t}-${plan.id}-${f.getTime()}` });
            
            if(plt.remojo > 0) { 
                let r = new Date(s); r.setDate(r.getDate()-1); 
                add(r, 'remojo', `REMOJAR ${plt.nombre}`); 
            }

            // --- INFO DE BANDEJA Y GRAMOS PARA SIEMBRA ---
            const area = B_AREAS[plan.bandeja] || 1250;
            const grPorBandeja = (plt.gramos * (area / 1250)).toFixed(1);
            const grTotales = (grPorBandeja * cant).toFixed(1);
            const msgSiembra = `SEMBRAR ${plt.nombre} (x${cant}) - [${plan.bandeja}] - ${grTotales}g total`;
            
            add(s, 'siembra', msgSiembra);
            
            let l = new Date(s); l.setDate(l.getDate() + plt.oscuro); 
            add(l, 'luz', `A LUZ ${plt.nombre}`);
            
            let c = new Date(s); c.setDate(c.getDate() + plt.total); 
            add(c, 'cosecha', `COSECHAR ${plt.nombre}`);
        }

        function showSection(id) { 
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
            const items = document.querySelectorAll('.nav-item');
            items.forEach(item => { if(item.getAttribute('onclick') && item.getAttribute('onclick').includes(`showSection('${id}')`)) item.classList.add('active'); });
            document.getElementById(id).classList.add('active'); 
            if(id==='visitas') renderVisitsCal(); 
        }
        function toggleCalendar() { document.getElementById('calendar-body').classList.toggle('show'); }
        function togglePlanModo(m) { document.getElementById('panel-individual').style.display = m==='individual'?'block':'none'; document.getElementById('panel-mix').style.display = m==='mix'?'block':'none'; }
        function addPlanta() {
            const id = document.getElementById('plt-id').value.toUpperCase();
            const p = { id, nombre: document.getElementById('plt-nombre').value, remojo: parseInt(document.getElementById('plt-remojo').value), oscuro: parseInt(document.getElementById('plt-oscuro').value), total: parseInt(document.getElementById('plt-total').value), gramos: parseInt(document.getElementById('plt-gramos').value), precio: parseFloat(document.getElementById('plt-precio').value) };
            if(!db.plantas) db.plantas = [];
            const idx = db.plantas.findIndex(x => x.id === id);
            if(idx > -1) db.plantas[idx] = p; else db.plantas.push(p);
            save();
        }
        function editPlanta(id) {
            const p = db.plantas.find(x => x.id === id);
            document.getElementById('plt-id').value = p.id;
            document.getElementById('plt-nombre').value = p.nombre;
            document.getElementById('plt-remojo').value = p.remojo;
            document.getElementById('plt-oscuro').value = p.oscuro;
            document.getElementById('plt-total').value = p.total;
            document.getElementById('plt-gramos').value = p.gramos;
            document.getElementById('plt-precio').value = p.precio;
        }
        function toggleTask(id) { if(!db.completadas) db.completadas=[]; if(db.completadas.includes(id)) db.completadas=db.completadas.filter(x=>x!==id); else db.completadas.push(id); save(); }
        function addCliente() { const n = document.getElementById('cli-nombre').value; if(n) { if(!db.clientes) db.clientes=[]; db.clientes.push({id:Date.now(), nombre:n}); save(); } }
        function addPlan() { 
            const p = { id: Date.now(), tipo: 'INDIVIDUAL', cliente: document.getElementById('plan-cliente').value, plantaId: document.getElementById('plan-planta').value, bandeja: document.getElementById('plan-tipo-bandeja').value, cant: parseInt(document.getElementById('plan-cant-ind').value), frec: parseInt(document.getElementById('plan-frec').value), fecha: document.getElementById('plan-fecha').value }; 
            if(p.fecha) { if(!db.planes) db.planes=[]; db.planes.push(p); save(); } 
        }
        function addPlanMix() { 
            let sel = []; 
            document.querySelectorAll('.mix-row').forEach(r => { 
                const chk = r.querySelector('.mix-chk'); const qty = r.querySelector('.mix-qty'); 
                if(chk.checked && parseInt(qty.value)>0) sel.push({id:chk.value, cant:parseInt(qty.value)}); 
            }); 
            const p = { id: Date.now(), tipo: 'MIX', cliente: document.getElementById('plan-cliente').value, detalleMix: sel, bandeja: document.getElementById('plan-tipo-bandeja').value, frec: parseInt(document.getElementById('plan-frec').value), fechaEntrega: document.getElementById('plan-fecha-entrega').value }; 
            if(sel.length>0) { if(!db.planes) db.planes=[]; db.planes.push(p); save(); togglePlanModo('individual'); } 
        }
        function addLoteManual() { 
            const pltId = document.getElementById('lote-planta').value; const pltObj = db.plantas.find(x=>x.id===pltId); 
            if(!db.ultimoCorrelativo) db.ultimoCorrelativo=0; db.ultimoCorrelativo++; 
            const cod = pltId + document.getElementById('lote-fecha').value.replace(/-/g,'').slice(2)+"-"+db.ultimoCorrelativo; 
            if(!db.lotes) db.lotes=[]; db.lotes.push({id:Date.now(), codigo:cod, plantaNombre:pltObj.nombre, cliente:document.getElementById('lote-cliente').value, cant:document.getElementById('lote-cant').value, fecha:document.getElementById('lote-fecha').value}); 
            save(); 
        }
        function renderLotesTable(data) { document.getElementById('tbody-lotes').innerHTML = data.map(l => `<tr><td>${l.codigo}</td><td>${l.plantaNombre}</td><td>${l.cliente}</td><td>${l.cant}</td><td>${l.fecha}</td><td><button class="btn btn-danger" onclick="borrar('lotes',${l.id})">X</button></td></tr>`).join(''); }
        function addVisita() { if(!db.visitas) db.visitas=[]; db.visitas.push({id:Date.now(), cliente:document.getElementById('visita-cliente').value, fecha:document.getElementById('visita-fecha').value, hora:document.getElementById('visita-hora').value, motivo:document.getElementById('visita-motivo').value}); save(); }
        function renderVisitsCal() {
            const grid = document.getElementById('visitas-grid'); if(!grid) return; grid.innerHTML = '';
            document.getElementById('cal-title').innerText = new Intl.DateTimeFormat('es-ES',{month:'long', year:'numeric'}).format(curMonth).toUpperCase();
            const totalDays = new Date(curMonth.getFullYear(), curMonth.getMonth()+1, 0).getDate();
            for(let d=1; d<=totalDays; d++) {
                const f = `${curMonth.getFullYear()}-${String(curMonth.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tags = (db.visitas || []).filter(v => v.fecha === f).map(v => `<div class="visit-tag">${v.cliente}</div>`).join('');
                grid.innerHTML += `<div class="calendar-day"><span class="day-num">${d}</span>${tags}</div>`;
            }
        }
        function changeMonth(d) { curMonth.setMonth(curMonth.getMonth()+d); renderVisitsCal(); }
        function toggleVisitsView(v) { document.getElementById('visitas-lista').style.display = v==='lista'?'block':'none'; document.getElementById('visitas-calendario').style.display = v==='calendario'?'block':'none'; }
        function runCalc() { const p = db.plantas.find(x => x.id === document.getElementById('calc-planta').value); if(!p) return; const g = (p.gramos * (parseFloat(document.getElementById('calc-bandeja').value)/1250)).toFixed(1); const coste = ((g/1000)*(p.precio||0)).toFixed(2); document.getElementById('calc-res').innerHTML = `<strong>${g}g</strong> / <span style="color:var(--primary)">Coste: ${coste}€</span>`; }
        function filterLotes() { const q = document.getElementById('search-lote-cliente').value.toLowerCase(); renderLotesTable(db.lotes.filter(l => l.cliente.toLowerCase().includes(q))); }
        function borrar(k, id) { if(confirm("¿Borrar?")) { db[k] = db[k].filter(x => x.id != id); save(); } }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `isla_db.json`; a.click(); }
        function clearData() { if(confirm("¿BORRAR TODO?")) { db = { clientes: [], plantas: [], planes: [], lotes: [], completadas: [], visitas: [], ultimoCorrelativo: 0 }; save(); } }
        window.onload = initApp;
    </script>
</body>
</html>
